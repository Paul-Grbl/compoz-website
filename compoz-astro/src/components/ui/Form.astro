---
import { Image } from "astro:assets";
import decorForm from "../../assets/pics/contact-pic.svg";
---

<div
  class="flex relative justify-start items-center p-10 sm:p-[60px] bg-[#F3F3F3] rounded-[45px] overflow-hidden"
>
  <form id="form" class="bg-gray sm:p-6 h-full w-full lg:max-w-lg">
    <div class="mb-4">
      <label for="name" class="block text-black mb-2">Nom*</label>
      <input
        type="text"
        id="name"
        name="name"
        placeholder="Nom"
        class="w-full px-[30px] py-[18px] border border-black rounded-[14px] text-black outline-none"
      />
    </div>

    <div class="mb-4">
      <span id="errorName" class="text-red-500" hidden
        >Min. 2 caractères. Caractères spéciaux interdits.</span
      >
    </div>

    <div class="mb-4" hidden>
      <label for="pseudo" class="block text-black mb-2">Pseudo*</label>
      <input
        type="text"
        id="pseudo"
        name="pseudo"
        placeholder="Pseudo"
        class="w-full px-[30px] py-[18px] border border-black rounded-[14px] text-black outline-none"
      />
    </div>

    <div class="mb-4">
      <label for="email" class="block text-black mb-2">Email*</label>
      <input
        type="email"
        id="email"
        name="email"
        placeholder="Email"
        class="w-full px-[30px] py-[18px] border border-black rounded-[14px] text-black outline-none"
      />
    </div>
    <div class="mb-4">
      <span id="errorEmail" class="text-red-500" hidden
        >Adresse email invalide</span
      >
    </div>

    <div class="mb-4">
      <label for="message" class="block text-black mb-2">Message*</label>
      <textarea
        id="message"
        name="message"
        placeholder="Décrivez votre projet en quelques lignes…"
        class="w-full px-[30px] py-[18px] border border-black rounded-[14px] text-black outline-none min-h-[10em]"
      ></textarea>
    </div>

    <div class="mb-4">
      <span id="responseMessage" class="text-primary"></span>
    </div>

    <div
      class="g-recaptcha mb-4"
      data-sitekey="6LdYXN4qAAAAAFpUmV-lRSrNLEtd4F0c_JwVf4u1"
    >
    </div>

    <button
      id="submitBtn"
      type="submit"
      name="submit"
      class="btn-primary w-full"
      disabled
    >
      Envoyer</button
    >
  </form>
  <picture class="absolute right-[-25%] left-[60%] top-[2%] hidden lg:block">
    <Image src={decorForm} alt="Illustration formulaire de contact" class="size-full" />
  </picture>
</div>
<script is:inline src="https://www.google.com/recaptcha/api.js" async defer
></script>
<script>
  declare const grecaptcha: any;

  function formSetup() {
    setTimeout(
      () =>
        ((document.getElementById("submitBtn") as HTMLButtonElement).disabled =
          false),
      3000,
    );

    const form = document.getElementById("form") as HTMLFormElement;
    const name = document.getElementById("name") as HTMLInputElement;
    const email = document.getElementById("email") as HTMLInputElement;
    const msg = document.getElementById("message") as HTMLInputElement;
    const errorName = document.getElementById("errorName");
    const errorEmail = document.getElementById("errorEmail");

    if (form && name && email && msg && errorEmail && errorName) {
      msg.addEventListener("input", function () {
        if (msg.value.length > 1000) {
          msg.value = msg.value.substring(0, 1000);
        }
      });

      form.addEventListener("submit", async function (event) {
        event.preventDefault();
        const responseMessage = document.getElementById("responseMessage");

        // Input validation
        let error = false;
        const regexName = new RegExp(/^[a-zA-ZÀ-ÿ' -]{2,50}$/);
        if (!regexName.test(name.value)) {
          errorName.removeAttribute("hidden");
          error = true;
        } else {
          errorName.setAttribute("hidden", "true");
        }

        const regexEmail = /^[a-zA-Z0-9._+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!regexEmail.test(email.value)) {
          errorEmail.removeAttribute("hidden");
          error = true;
        } else {
          errorEmail.setAttribute("hidden", "true");
        }

        if (error) {
          return;
        }

        const formData = new FormData(this);

        try {
          const response = await fetch("https://www.compoz.tech/sendmail.php", {
            method: "POST",
            body: formData,
          });

          grecaptcha.reset();

          if (responseMessage && response.status === 200) {
            responseMessage.innerText = "Email envoyé avec succès.";
            responseMessage.classList.remove("text-red-500");
          } else {
            throw "Error";
          }
        } catch (error) {
          if (responseMessage) {
            responseMessage.innerText = "Erreur lors de l'envoi du message.";
            responseMessage.classList.add("text-red-500");
          }
        }
      });
    }
  }

  formSetup();
  document.addEventListener("astro:after-swap", formSetup);
</script>
